user www;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
    multi_accept on;
}

##
# Kubernetes API
##

stream {
    server {
        listen 6443;
        proxy_pass k8nodesAPI;
    }

    upstream k8nodesAPI {
        # s1.analitico.ai
        server 138.201.196.111:6443 fail_timeout=0;
        # s2.analitico.ai
        server 78.46.46.165:6443 fail_timeout=0 backup;   
        # s3.analitico.ai
        server 178.63.48.57:6443 fail_timeout=0 backup;
        # p2.analitico.ai
        server 195.201.163.22:6443 fail_timeout=0 backup;
    }
}

http {

    ##
    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings
    # see: https://medium.com/@mvuksano/how-to-properly-configure-your-nginx-for-tls-564651438fe0
    ##

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
    ssl_prefer_server_ciphers on;
    ssl_certificate           /root/certs/analitico.ai.crt;
    ssl_certificate_key       /root/certs/analitico.ai.key;
    ssl_session_cache shared:SSL:40m;
    ssl_session_timeout 4h;
    ssl_session_tickets on;

    ##
    # Logging Settings
    ##

    log_format netdata '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '$request_length $request_time $upstream_response_time '
                    '"$http_referer" "$http_user_agent" $request_body';

    access_log /var/log/nginx/access.log netdata;
    error_log /var/log/nginx/error.log info;

    ##
    # Gzip Settings
    ##

    gzip on;

    # tells proxies to cache both gzipped and regular versions of a resource
    gzip_vary on;
    # disable compression for Internet Explorer versions 1-6
    gzip_disable "MSIE [1-6]\.";
    # compress data even for clients that are connecting via proxies
    gzip_proxied expired no-cache no-store private auth;
    # enables the types of files that can be compressed
    gzip_types application/javascript text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss; 

    ##
    # Proxy Settings
    ##

    proxy_http_version 1.1;
    proxy_connect_timeout 10s;
    proxy_next_upstream error timeout;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # enable nginx to properly handle the WebSocket protocol 
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    upstream k8nodes {
        # s1.analitico.ai
        server 138.201.196.111:31380 fail_timeout=0;
        # s2.analitico.ai
        server 78.46.46.165:31380 fail_timeout=0 backup;
        # s3.analitico.ai  
        server 178.63.48.57:31380 fail_timeout=0 backup;
        # p2.analitico.ai
        server 195.201.163.22:31380 fail_timeout=0 backup;
    }

    upstream k8nodesSSL {
        # s1.analitico.ai
        server 138.201.196.111:31390 fail_timeout=0;
        # s2.analitico.ai
        server 78.46.46.165:31390 fail_timeout=0 backup;
        # s3.analitico.ai  
        server 178.63.48.57:31390 fail_timeout=0 backup;
        # p2.analitico.ai
        server 195.201.163.22:31390 fail_timeout=0 backup;
    }

    upstream k8prometheusNodes { 
        # s1.analitico.ai
        server 138.201.196.111:32464 fail_timeout=0;
        # s2.analitico.ai
        server 78.46.46.165:32464 fail_timeout=0 backup;
        # s3.analitico.ai  
        server 178.63.48.57:32464 fail_timeout=0 backup;
        # p2.analitico.ai
        server 195.201.163.22:32464 fail_timeout=0 backup;
    }

    upstream k8dashboardNodes { 
        # s1.analitico.ai
        server 138.201.196.111:31113 fail_timeout=0;
        # s2.analitico.ai
        server 78.46.46.165:31113 fail_timeout=0 backup;
        # s3.analitico.ai  
        server 178.63.48.57:31113 fail_timeout=0 backup;
        # p2.analitico.ai
        server 195.201.163.22:31113 fail_timeout=0 backup;
    }

    # values for the WebSocket headers
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # do not serve from other domains
    server {
        return 404;
    }

    server {
        server_name 127.0.0.1;

        # used by netdata for status checks
        location /stub_status {
            stub_status;
            # Security: Only allow access from the IP below.
            allow 127.0.0.1;
            # Deny anyone else
            deny all;
        }
    }

    ##
    # Redirect to HTTPS 
    # http://analitico.ai to https://analitico.ai
    ##

    server {
        listen 80;
        server_name analitico.ai;
        # only GET requests, redirect to HTTPS
        add_header Allow "GET, HEAD" always;
        if ( $request_method !~ ^(GET|HEAD)$ ) {
            return 405 "Please use HTTPS for POST";
        }
        # redirect naked domain to https
        return 301 https://analitico.ai$request_uri;
    }

    ##
    # Redirect to HTTPS
    # https://*.analitico.ai to https://*.analitico.ai
    ##

    server {
        listen 80;
        server_name  ~^(?<subdomain>.+)\.analitico\.ai$;
        # only GET requests, redirect to HTTPS
        add_header Allow "GET, HEAD" always;
        if ( $request_method !~ ^(GET|HEAD)$ ) {
            return 405 "Please use HTTPS for POST";
        }
        return 301 https://$subdomain.analitico.ai$request_uri;
    }

    ##
    # Redirect https://www.analitico.ai to https://analitico.ai
    ##

    server {
        listen 443 ssl http2;
        server_name www.analitico.ai;

        return 301 https://analitico.ai$request_uri;
    }

    ##
    # Kubernetes Dashboard
    # https://dashboard.cloud.analitico.ai
    ##

    server {
        listen 443 ssl http2;
        server_name dashboard.cloud.analitico.ai;

        location / {
            proxy_pass https://k8dashboardNodes;            
        }
    }

    ##
    # Prometheus 
    # https://prometheus.cloud.analitico.ai
    ##

    server {
        listen 443 ssl http2;
        server_name prometheus.cloud.analitico.ai;

        location / {
            # works on port 80 only
            proxy_pass http://k8prometheusNodes;
        }
    }
    
    ##
    # Webdav mount route
    # https://ws-*.cloud.analitico.ai
    ## 

    server {
        listen 443 ssl http2;
        server_name ~^ws-[\w-]+\.cloud\.analitico\.ai$;

        # long timeouts for uploading and downloading large batches
        proxy_connect_timeout 120m;
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_send_timeout
        proxy_send_timeout 120m;        
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_read_timeout
        proxy_read_timeout 120m;
        # timeout for two successive sends to client, not whole response
        send_timeout 90;
        
        # Uploads can be huge
        client_max_body_size 16g;

        location / {
            proxy_pass https://k8nodesSSL;

            # map to hostname of api service to be recognized by knative
            proxy_set_header Host api.cloud.analitico.ai;
            # send original host
            proxy_set_header X-Forwarded-Host $host;

            proxy_redirect off;
        }
    }

    ##
    # Production
    # https://analitico.ai
    # https://*.analitico.ai
    ##

    server {
        listen 443 ssl http2;
        server_name ~^[\w-]+.analitico.ai$ analitico.ai;

        # long timeouts for uploading and downloading large batches
        proxy_connect_timeout 120m;
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_send_timeout
        proxy_send_timeout 120m;        
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_read_timeout
        proxy_read_timeout 120m;
        # timeout for two successive sends to client, not whole response
        send_timeout 90;
        
        # Uploads can be huge
        client_max_body_size 16g;

        # DEPRECATED 2019-08-27
        # Bypass old s24 not serverless endpoints
        location = /api/endpoints/ep_s24_ordersorting/predict {
            proxy_pass https://ep-s24-ordersorting-v2.cloud.analitico.ai/;
            add_header X-Analitico-Bypass https://ep-s24-ordersorting-v2.cloud.analitico.ai always;
            proxy_redirect off; 
            proxy_set_header Host ep-s24-ordersorting-v2.cloud.analitico.ai;
        }

        # DEPRECATED 2019-08-27
        location = /api/endpoints/ep_s24_outofstock/predict {
            proxy_pass https://ep-s24-outofstock-v2.cloud.analitico.ai/;
            add_header X-Analitico-Bypass https://ep-s24-outofstock-v2.cloud.analitico.ai always;
            proxy_redirect off;  
            proxy_set_header Host ep-s24-outofstock-v2.cloud.analitico.ai;
        }

        # routes that are managed by Django
        location ~ ^/(api|admin|accounts) {
            proxy_pass https://k8nodesSSL;

            # map to hostname of api service to be recognized by knative
            proxy_set_header Host api.cloud.analitico.ai;
            # send original host
            proxy_set_header X-Forwarded-Host $host;

            proxy_redirect off;
        }

         # analitico website's static files
        location /app {
            # served from on the mount point to the remote storage
            alias /mnt/analitico-drive/production;
            # tell nginx to always resolve /app routing to index.html
            # because react router uses the url /app/page instead
            # of the url with the hash /app/#page
            try_files $uri$args /app/index.html;
            
            # disable browser caching for index.html
            location =/app/index.html {
                add_header 'Cache-Control' 'no-cache, no-store, must-revalidate' always;
                add_header 'Pragma' 'no-cache' always;
                add_header 'Expires' '0' always;
            }
            # always revalidate app.js
            location =/app/app.js {
                add_header 'Cache-Control' 'no-cache, must-revalidate' always;
                add_header 'Pragma' 'no-cache' always;
            }
        }

        # django static files
        location /static {
            alias /mnt/analitico-drive/production/static;
        }

        # proxy pass to marketing static site
        location / {
            proxy_pass https://site.analitico.ai;
            proxy_set_header Host site.analitico.ai;
            
            proxy_redirect off;
        }
    }

    ##
    # Serverless (production)
    # https://*.cloud.analitico.ai
    ##

    server {
        listen 443 ssl http2;
        # regex is used to distinguish from ws-*.cloud.analitico.ai which is used by file api
        server_name ~^.+\.cloud\.analitico\.ai;

        location / {
            proxy_pass https://k8nodesSSL;

            proxy_redirect off;
        }
    }

    ##
    # Staging
    # https://staging.analitico.ai
    ##

    server {
        listen 443 ssl http2;
        server_name staging.analitico.ai;

        # long timeouts for uploading and downloading large batches
        proxy_connect_timeout 120m;
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_send_timeout
        proxy_send_timeout 120m;        
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_read_timeout
        proxy_read_timeout 120m;
        # timeout for two successive sends to client, not whole response
        send_timeout 90;
        
        # Uploads can be huge
        client_max_body_size 16g;

        # routes that are managed by Django
        location ~ ^/(api|admin|accounts) {
            proxy_pass https://k8nodesSSL;

            # map to hostname of api-staging service to be recognized by knative
            proxy_set_header Host api-staging.cloud.analitico.ai;
            # send original host
            proxy_set_header X-Forwarded-Host $host;

            proxy_redirect off;
        }

         # analitico website's static files
        location /app {
            # served from on the mount point to the remote storage
            alias /mnt/analitico-drive/staging;
            try_files $uri$args /app/index.html;

            # disable browser caching for index.html
            location =/app/index.html {
                add_header 'Cache-Control' 'no-cache, no-store, must-revalidate' always;
                add_header 'Pragma' 'no-cache' always;
                add_header 'Expires' '0' always;
            }
            # always revalidate app.js
            location =/app/app.js {
                add_header 'Cache-Control' 'no-cache, must-revalidate' always;
                add_header 'Pragma' 'no-cache' always;
            }
        }

        # django static files
        location /static {
            alias /mnt/analitico-drive/staging/static;
        }

        # proxy pass to marketing static site
        location / {
            proxy_pass https://site.analitico.ai;
            
            proxy_set_header Host site.analitico.ai;

            proxy_redirect off;
        }
    }

    ##
    # Deprecated
    ## 

    # DEPRECATED 2019-08-14
    # old.analitico.ai is mapped to website-old service
    server {
        listen 443 ssl http2;
        # analitico.ai third levels domains
        server_name old.analitico.ai;

        # long timeouts for uploading and downloading large batches
        proxy_connect_timeout 120m;
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_send_timeout
        proxy_send_timeout 120m;        
        # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_read_timeout
        proxy_read_timeout 120m;
        # timeout for two successive sends to client, not whole response
        send_timeout 90;
        
        # Uploads can be huge
        client_max_body_size 16g;


        location / {
            proxy_pass    https://k8nodesSSL;
            # map to hostname of website-staging service to be recognized by knative
            proxy_set_header Host website-old.cloud.analitico.ai;
            # send original host
            proxy_set_header X-Forwarded-Host $host;
            proxy_redirect off;    
        }

    }
}



