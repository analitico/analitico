user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}

# TCP stream to k8 API servers
stream {
    server {
        listen 6443;
        proxy_pass k8nodesAPI;
    }

    server {
        # balancer listens also to 6445, in this way it can be run on a master machine
        listen 6445;
        proxy_pass k8nodesAPI;
    }

    upstream k8nodesAPI {
        least_conn;
        # s1.analitico.ai
        server 138.201.196.111:6443 fail_timeout=0s;
        # s2.analitico.ai
        server 78.46.46.165:6443 fail_timeout=0s;      
        # s3.analitico.ai
        server 178.63.48.57:6443 fail_timeout=0s;
   }
}

http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        # server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##
        log_format netdata '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '$request_length $request_time $upstream_response_time '
                       '"$http_referer" "$http_user_agent" $request_body';
  
        access_log /var/log/nginx/access.log netdata;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # tells proxies to cache both gzipped and regular versions of a resource
        gzip_vary on;
        # disable compression for Internet Explorer versions 1-6
        gzip_disable "MSIE [1-6]\.";
        # compress data even for clients that are connecting via proxies
        gzip_proxied expired no-cache no-store private auth;
        # enables the types of files that can be compressed
        gzip_types application/javascript text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss; 


        upstream k8nodes {
            least_conn;
            # s1.analitico.ai
            server 138.201.196.111:31380;
            # s2.analitico.ai
            server 78.46.46.165:31380;
            # s3.analitico.ai  
            server 178.63.48.57:31380;
        }

        upstream k8nodesSSL {
            least_conn;
            # s1.analitico.ai
            server 138.201.196.111:31390;
            # s2.analitico.ai
            server 78.46.46.165:31390;
            # s3.analitico.ai  
            server 178.63.48.57:31390;
        }

        upstream k8prometheusNodes { 
            least_conn;
            # s1.analitico.ai
            server 138.201.196.111:32464;
            # s2.analitico.ai
            server 78.46.46.165:32464;
            # s3.analitico.ai  
            server 178.63.48.57:32464;
        }

        upstream k8dashboardNodes { 
            least_conn;
            # s1.analitico.ai
            server 138.201.196.111:31113;
            # s2.analitico.ai
            server 78.46.46.165:31113;
            # s3.analitico.ai  
            server 178.63.48.57:31113;
        }

        # do not serve from other domains
        server {
            return 404;
        }
        
        server {
            listen 80;
            server_name prometheus.cloud.analitico.ai;

            location / {
                proxy_pass    http://k8PrometheusNodes;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;
                proxy_set_header Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
            }
        }

        server {
            listen 80;
            server_name *.cloud.analitico.ai cloud.analitico.ai;

            location / {
                proxy_pass    http://k8nodes;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;   
                proxy_set_header Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
            }
        }

         # redirect http://analitico.ai to https
        server {
            listen 80;
            server_name analitico.ai;
            # only GET requests, redirect to HTTPS
            add_header Allow "GET, HEAD" always;
            if ( $request_method !~ ^(GET|HEAD)$ ) {
                return 405 "Please use HTTPS for POST";
            }
            # redirect naked domain to https
            return 301 https://analitico.ai$request_uri;
        }

        # redirect http://*.analitico.ai to https
        server {
            listen 80;
            server_name  ~^(?<subdomain>.+)\.analitico\.ai$;
            # only GET requests, redirect to HTTPS
            add_header Allow "GET, HEAD" always;
            if ( $request_method !~ ^(GET|HEAD)$ ) {
                return 405 "Please use HTTPS for POST";
            }
            return 301 https://$subdomain.analitico.ai$request_uri;
        }


        # ssl for prometheus.cloud.analitico.ai
        server {
            listen 443 ssl;
            server_name prometheus.cloud.analitico.ai;

            ssl_certificate           /root/certs/analitico.ai.crt;
            ssl_certificate_key       /root/certs/analitico.ai.key;

            location / {
                    # works on port 80 only
                    proxy_pass    http://k8prometheusNodes;
                    proxy_http_version 1.1;
                    proxy_connect_timeout 1s;
                    proxy_set_header Host $host;
                    proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
                }
        }
        
        # ssl for dashboard.cloud.analitico.ai
        server {
            listen 443 ssl;
            server_name dashboard.cloud.analitico.ai;

            ssl_certificate           /root/certs/analitico.ai.crt;
            ssl_certificate_key       /root/certs/analitico.ai.key;

            location / {
                    proxy_pass    https://k8dashboardNodes;
                    proxy_ssl_certificate         /root/certs/analitico.ai.crt;
                    proxy_ssl_certificate_key     /root/certs/analitico.ai.key;
                    proxy_http_version 1.1;
                    proxy_connect_timeout 1s;
                    proxy_set_header Host $host;
                    proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
                }
        }

        # Domain and third level domains (analitico.ai and *.analitico.ai)
        # These domains point to knative service at website.cloud.analitico.ai 
        # ssl for analitico.ai and  .analitico.ai, still missing proxy_pass ssl
        server {
            listen 443 ssl;
            # analitico.ai and *.analitico.ai
            server_name *.analitico.ai analitico.ai;

            ssl_certificate           /root/certs/analitico.ai.crt;
            ssl_certificate_key       /root/certs/analitico.ai.key;

            # long timeouts for uploading and downloading large batches
            proxy_connect_timeout 15m;
            # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_send_timeout
            proxy_send_timeout 15m;        
            # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_read_timeout
            proxy_read_timeout 15m;
            # timeout for two successive sends to client, not whole response
            send_timeout 90;
            # how long client connection will stay open on the server side
            keepalive_timeout 90;
            
            # Uploads can be huge
            client_max_body_size 16g;


            # Bypass old s24 not serverless endpoints
            location /api/endpoints/ep_s24_ordersorting/predict {
                proxy_pass https://ep-s24-ordersorting-v2.cloud.analitico.ai/;
                add_header X-Analitico-Bypass https://ep-s24-ordersorting-v2.cloud.analitico.ai always;
                proxy_redirect off; 
                proxy_set_header Host ep-s24-ordersorting-v2.cloud.analitico.ai;
            }

            location /api/endpoints/ep_s24_outofstock/predict {
                proxy_pass https://ep-s24-outofstock-v2.cloud.analitico.ai/;
                add_header X-Analitico-Bypass https://ep-s24-outofstock-v2.cloud.analitico.ai always;
                proxy_redirect off;  
                proxy_set_header Host ep-s24-outofstock-v2.cloud.analitico.ai;
            }

            location / {
                proxy_pass    https://k8nodesSSL;
                proxy_ssl_certificate         /root/certs/analitico.ai.crt;
                proxy_ssl_certificate_key     /root/certs/analitico.ai.key;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;
                # map to hostname of website service to be recognized by knative
                proxy_set_header Host website.cloud.analitico.ai;
                # send original host
                proxy_set_header X-Forwarded-Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
                proxy_redirect off;    
            }
        }


        # ssl for *.cloud.analitico.ai
        server {
            listen 443 ssl;
            server_name *.cloud.analitico.ai cloud.analitico.ai;

            ssl_certificate           /root/certs/analitico.ai.crt;
            ssl_certificate_key       /root/certs/analitico.ai.key;

            location / {
                proxy_pass    https://k8nodesSSL;
                proxy_ssl_certificate         /root/certs/analitico.ai.crt;
                proxy_ssl_certificate_key     /root/certs/analitico.ai.key;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;   
                proxy_set_header Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
            }
        }

}



