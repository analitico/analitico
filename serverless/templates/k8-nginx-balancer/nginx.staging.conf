##
# Staging Load Balancer Nginx
##

user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 1024;
}

# TCP stream to k8 API servers
stream {
    server {
        listen 6443;
        proxy_pass k8nodesAPI;
    }

    upstream k8nodesAPI {
        least_conn;
        # staging1.analitico.ai
        server 116.202.100.29:6443;
        # staging2.analitico.ai
        server 116.202.100.27:6443;      
        # staging3.analitico.ai
        server 116.202.100.28:6443;
   }
}

http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        server_tokens off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Settings
        # see: https://medium.com/@mvuksano/how-to-properly-configure-your-nginx-for-tls-564651438fe0
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##
        log_format netdata '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '$request_length $request_time $upstream_response_time '
                       '"$http_referer" "$http_user_agent" $request_body';
  
        access_log /var/log/nginx/access.log netdata;
        error_log /var/log/nginx/error.log info;

        ##
        # Gzip Settings
        ##

        gzip on;

        # tells proxies to cache both gzipped and regular versions of a resource
        gzip_vary on;
        # disable compression for Internet Explorer versions 1-6
        gzip_disable "MSIE [1-6]\.";
        # compress data even for clients that are connecting via proxies
        gzip_proxied expired no-cache no-store private auth;
        # enables the types of files that can be compressed
        gzip_types application/javascript text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss; 


        upstream k8nodes {
            least_conn;
            # staging1.analitico.ai
            server 116.202.100.29:31380;
            # staging2.analitico.ai
            server 116.202.100.27:31380;      
            # staging3.analitico.ai
            server 116.202.100.28:31380;
        }

        upstream k8nodesSSL {
            least_conn;
            # staging1.analitico.ai
            server 116.202.100.29:31390;
            # staging2.analitico.ai
            server 116.202.100.27:31390;      
            # staging3.analitico.ai
            server 116.202.100.28:31390;
        }

        upstream k8prometheusNodes {
            least_conn;
            # staging1.analitico.ai
            server 116.202.100.29:32464;
            # staging2.analitico.ai
            server 116.202.100.27:32464;      
            # staging3.analitico.ai
            server 116.202.100.28:32464;
        }

        upstream k8dashboardNodes { 
            least_conn;
            # staging1.analitico.ai
            server 116.202.100.29:31113;
            # staging2.analitico.ai
            server 116.202.100.27:31113;      
            # staging3.analitico.ai
            server 116.202.100.28:31113;
        }

        # values for the WebSocket headers
        map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
        }

        # do not serve from other domains
        server {
            return 404;
        }

        server {
            server_name 127.0.0.1;

            # used by netdata for status checks
            location /stub_status {
                stub_status;
                # Security: Only allow access from the IP below.
                allow 127.0.0.1;
                # Deny anyone else
                deny all;
            }
        }

        # ssl for prometheus.cloud-staging.analitico.ai
        server {
            listen 443 ssl http2;
            server_name prometheus.cloud-staging.analitico.ai;

            ssl_certificate           /root/certs/analitico.ai.crt;
            ssl_certificate_key       /root/certs/analitico.ai.key;
            ssl_session_cache shared:SSL:40m;
            ssl_session_timeout 4h;
            ssl_session_tickets on;

            location / {
                    # works on port 80 only
                    proxy_pass    http://k8prometheusNodes;
                    
                    proxy_set_header Host $host;
                    proxy_set_header Connection $connection_upgrade;
                    
                    proxy_http_version 1.1;
                    proxy_connect_timeout 1s;
                    proxy_next_upstream error timeout;
                }
        }
        
        # ssl for dashboard.cloud-staging.analitico.ai
        server {
            listen 443 ssl http2;
            server_name dashboard.cloud-staging.analitico.ai;

            ssl_certificate           /root/certs/analitico.ai.crt;
            ssl_certificate_key       /root/certs/analitico.ai.key;
            ssl_session_cache shared:SSL:40m;
            ssl_session_timeout 4h;
            ssl_session_tickets on;

            location / {
                    proxy_pass    https://k8dashboardNodes;
                    proxy_ssl_certificate         /root/certs/analitico.ai.crt;
                    proxy_ssl_certificate_key     /root/certs/analitico.ai.key;
                    
                    proxy_set_header Host $host;
                    
                    proxy_http_version 1.1;
                    proxy_connect_timeout 1s;
                    proxy_next_upstream error timeout;
                }
        }

        # *.cloud-staging.analitico.ai
        server {
            listen 80;
            server_name *.cloud-staging.analitico.ai cloud-staging.analitico.ai;

            location / {
                proxy_pass    http://k8nodes;
                proxy_ssl_certificate         /root/certs/analitico.ai.crt;
                proxy_ssl_certificate_key     /root/certs/analitico.ai.key;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;
                proxy_set_header Host $host;
                # enable nginx to properly handle the WebSocket protocol
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_next_upstream error timeout;
            }
        }

        # ssl for *.cloud-staging.analitico.ai
        server {
            listen 443 ssl http2;
            server_name *.cloud-staging.analitico.ai cloud-staging.analitico.ai;

            ssl_certificate           /root/certs/analitico.ai.crt;
            ssl_certificate_key       /root/certs/analitico.ai.key;
            ssl_session_cache shared:SSL:40m;
            ssl_session_timeout 4h;
            ssl_session_tickets on;

            location / {
                proxy_pass    https://k8nodesSSL;
                proxy_ssl_certificate         /root/certs/analitico.ai.crt;
                proxy_ssl_certificate_key     /root/certs/analitico.ai.key;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;   
                proxy_set_header Host $host;
                # enable nginx to properly handle the WebSocket protocol
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_next_upstream error timeout;
            }
        }
}
