<div class="ao-item-view ao-recipe-view">
    <div class="ao-padding">
        <div class="ao-margin-bottom">
            <app-ao-smart-input-box *ngIf="item" [item]="item.attributes.title" [placeholder]="item.id"
                (newValue)="changeItemTitle($event)"></app-ao-smart-input-box>
        </div>
        <mat-tab-group [selectedIndex]="activeTabIndex" (selectedIndexChange)="selectedTabChanged($event)">
            <mat-tab label="Recipe">
                <div class="ao-margin-top-bottom">

                    <section>
                        <h2 class="mat-h2">Dataset</h2>
                        <p class="mat-body">
                            Select the dataset to be used in this recipe or upload a new file (e.g. .csv)
                        </p>
                        <mat-select placeholder="Select dataset" [(ngModel)]="selectedDataset"
                            *ngIf="datasets && datasets.length" (selectionChange)="changedDataset()"
                            style="width: 80%; max-width: 500px; margin-top: 16px; margin-right: 40px; font-size: 14px;">
                            <mat-option *ngFor="let dataset of datasets" [value]="dataset">
                                {{(dataset.attributes && dataset.attributes.title) || dataset.id}}
                            </mat-option>
                        </mat-select>

                        <a mat-raised-button routerLink="/datasets/{{selectedDataset.id}}" *ngIf="selectedDataset">view
                            dataset</a>


                        <div class="ao-upload-drop-zone" [fileUploadInputFor]="fileUploadQueue"
                            [getUploadUrl]="getNewDatasetUploadUrl" [uploaded]="afterNewDatasetUploaded">
                            <i class="material-icons ao-text-center">
                                save_alt
                            </i>

                            <span>Drop your file here to create a new dataset</span>
                        </div>

                    </section>
                    <mat-divider></mat-divider>
                    <section>
                        <h2 class="mat-h2">Recipe</h2>
                        <p class="mat-body">
                            Please describe the problem that you want to resolve.<br>
                            E.g. I want to forecast if the product I'm going to sell will be out of stock.
                        </p>
                        <div *ngIf="!hasPipeline">
                            <!-- describe your recipe -->
                            <mat-form-field *ngIf="item && item.attributes"
                                style="min-height: 150px; width: 80%; max-width: 500px;">
                                <textarea matInput [(ngModel)]="item.attributes.description"
                                    placeholder="Describe the problem that you are trying to solve"
                                    style="min-height: 150px;"></textarea>
                            </mat-form-field>
                            <div>
                                <button mat-raised-button (click)="save()" color="primary">Wake up Analitico
                                    Genius</button>
                            </div>

                        </div>
                        <div [class.ao-d-none]="!hasPipeline">
                            <p class="mat-body">You can build your recipe using the plugins on the right.

                                Drag and drop, move and delete the plugins to build your recipe.
                            </p>
                            <p class="mat-body">
                                When it is perfect, hit the "Train new model" button below.
                            </p>

                            <mat-sidenav-container class="ao-recipe-view-sidenav-container sidenav-container">
                                <mat-sidenav-content>

                                    <ng-template app-ao-anchor></ng-template>
                                    <div style="margin: 20px auto;" class="ao-text-center">
                                        <!-- save button -->
                                        <button mat-raised-button (click)="save()">Save recipe</button>

                                    </div>

                                    <div style="margin: 20px auto;" class="ao-text-center">

                                        <!-- Process button -->
                                        <button mat-raised-button (click)="train()" style="margin: 10px"
                                            *ngIf="hasPipeline" color="primary">Train
                                            new model
                                            <mat-progress-spinner mode="indeterminate" *ngIf="isProcessing"
                                                [diameter]="20" [strokeWidth]="4">
                                            </mat-progress-spinner>
                                        </button>
                                    </div>
                                </mat-sidenav-content>
                                <mat-sidenav mode="side" position="end" [opened]="true"
                                    class="ao-recipe-view-sidenav sidenav">
                                    <div class="" cdkDropList [cdkDropListConnectedTo]="['ao-plugin-destination']"
                                        [cdkDropListData]="plugins">
                                        <div *ngFor="let plugin of plugins" cdkDrag class="ao-new-plugin">
                                            <mat-card>
                                                {{plugin.name.replace('analitico.plugin.', '')}}
                                            </mat-card>
                                        </div>
                                    </div>
                                </mat-sidenav>
                            </mat-sidenav-container>
                        </div>
                    </section>
                </div>
            </mat-tab>

            <!-- Models tab-->
            <mat-tab label="Models">
                <div class="ao-margin-top-bottom">
                    <app-ao-model-view [model]="selectedModel"></app-ao-model-view>
                </div>
                <div class="ao-margin-top-bottom">

                    <div class="ao-placeholder ao-clickable" *ngIf="!models || models.length === 0"
                        (click)="selectedTabChanged(0)">
                        <div class="ao-placeholder-background"></div>
                        <div class="ao-placeholder-image"><img src="assets/images/empty.jpg"></div>
                        <div class="ao-placeholder-text">
                            <p>No models</p>
                            <p>Go to the recipe section to train a new model</p>
                        </div>
                    </div>
                    <div *ngIf="models && models.length > 0">
                        <mat-divider style="margin-bottom: 40px;"></mat-divider>
                        <h2 class="mat-h2">Models</h2>
                        <p class="mat-body">This is the list of models based on this recipe. <br>
                            You can produce a new trained model in the recipe section</p>
                        <p class="mat-body">
                            <i>Please note that both the recipe and its data sources, which have been used for the
                                training,
                                may
                                have changed overtime, thus models may be not equivalent.</i>
                        </p>
                        <div class="ao-margin-top" style="max-height: 500px; overflow: auto;">

                            <table mat-table [dataSource]="tableModels" class="mat-elevation-z8" style="width: 100%;">

                                <ng-container matColumnDef="title">
                                    <th mat-header-cell *matHeaderCellDef> Title </th>
                                    <td mat-cell *matCellDef="let element">
                                        {{element.attributes.title || element.id}}
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="kpi0">
                                    <th mat-header-cell *matHeaderCellDef> KPI </th>
                                    <td mat-cell *matCellDef="let element">
                                        <p *ngFor="let kpi of element._aoprivate.kpi">
                                            {{kpi.name}}: {{kpi.value}}
                                        </p>

                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="updatedAt">
                                    <th mat-header-cell *matHeaderCellDef> Updated At </th>
                                    <td mat-cell *matCellDef="let element">
                                        {{element.attributes.updated_at | date:'dd/MM/yyyy HH:mm:ss'}}
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="endpoint">
                                    <th mat-header-cell *matHeaderCellDef> Endpoint </th>
                                    <td mat-cell *matCellDef="let element">
                                        <a mat-button (click)="$event.preventDefault(); $event.stopPropagation();"
                                            *ngIf="element._aoprivate.endpoints.length > 0">
                                            {{element._aoprivate.endpoints[0].attributes.title || element._aoprivate.endpoints[0].id}}
                                        </a>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef> Actions </th>
                                    <td mat-cell *matCellDef="let element">
                                        <button mat-raised-button 
                                            *ngIf="element._aoprivate.endpoints.length === 0"
                                            (click)="$event.preventDefault(); $event.stopPropagation(); requestToSetNewModel(element); ">Deploy</button>
                                    </td>
                                </ng-container>

                                <tr mat-header-row
                                    *matHeaderRowDef="['title', 'kpi0', 'updatedAt', 'endpoint', 'actions']; sticky: true">
                                </tr>
                                <tr mat-row
                                    *matRowDef="let row; columns: ['title', 'kpi0', 'updatedAt', 'endpoint', 'actions'];"
                                    class="ao-clickable" (click)="selectedModel = row" [class.ao-active-background]="selectedModel === row">
                                </tr>
                            </table>
                        </div>
                    </div>

                </div>
            </mat-tab>

            <mat-tab label="Live">
                <div class="ao-margin-top-bottom">


                    <div class="ao-placeholder ao-clickable" *ngIf="endpoints && endpoints.length===0"
                        (click)="selectedTabChanged(1)">
                        <div class="ao-placeholder-background"></div>
                        <div class="ao-placeholder-image"><img src="assets/images/empty.jpg"></div>
                        <div class="ao-placeholder-text">
                            <p>No live data</p>
                            <p>Go to the models section to deploy <br>a trained model</p>
                        </div>
                    </div>


                    <div *ngIf="endpoints && endpoints.length===1">

                        <p class="mat-body">Endpoint url</p>
                        <p class="mat-body">
                            <code>{{endpoints[0].links.self + '/predict'}}</code>
                        </p>

                    </div>
                </div>

            </mat-tab>
        </mat-tab-group>
    </div>
</div>

<app-ao-mat-file-upload-queue #fileUploadQueue multiple id="ao-file-upload-queue">
    <app-ao-mat-file-upload [file]="fileItem.file" [id]="i"
        *ngFor="let fileItem of fileUploadQueue.files; let i = index"
        (uploaded)="fileItem.uploaded ? fileItem.uploaded(fileItem) : true" [fileAlias]="'file'"
        [httpUrl]="fileItem.uploadUrl"></app-ao-mat-file-upload>
</app-ao-mat-file-upload-queue>