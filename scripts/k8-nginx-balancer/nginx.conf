user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}


http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        # server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 6;
        # gzip_buffers 16 8k;
        # gzip_http_version 1.1;
        # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        ##
        # Virtual Host Configs
        ##

        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
}

stream {
    server {
        # k8 apiserver
        listen 6443;
        proxy_pass k8nodes;
    }

    upstream k8nodes {
        least_conn;
        # s1.analitico.ai
        server 138.201.196.111:6443 fail_timeout=0s;
        # s2.analitico.ai
        server 78.46.46.165:6443 fail_timeout=0s;      
        # s3.analitico.ai
        server 178.63.48.57:6443 fail_timeout=0s;
   }
}

upstream k8nodes {
        least_conn;
        # s1.analitico.ai
        server 138.201.196.111:31380;
        # s2.analitico.ai
        server 78.46.46.165:31380;
        # s3.analiticio.ai  
        server 178.63.48.57:31380;
}

upstream k8nodesSSL {
        least_conn;
        # s1.analitico.ai
        server 138.201.196.111:443;
        # s2.analitico.ai
        server 78.46.46.165:443;
        # s3.analiticio.ai  
        server 178.63.48.57:443;
}

upstream k8prometheusNodes { 
        least_conn;
        # s1.analitico.ai
        server 138.201.196.111:32464;
        # s2.analitico.ai
        server 78.46.46.165:32464;
        # s3.analiticio.ai  
        server 178.63.48.57:32464;
}

server {
        listen 80;
        server_name prometheus.cloud.analitico.ai;

        location / {
                proxy_pass    http://k8PrometheusNodes;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;
                proxy_set_header Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
            }
}

server {
        listen 80;
        server_name *.cloud.analitico.ai cloud.analitico.ai;

	location / {
                proxy_pass    http://k8nodes;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;   
                proxy_set_header Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
            }
}

# ssl for prometheus.cloud.analitico.ai, still missing proxy_pass ssl
server {
        listen 443 ssl;
        server_name prometheus.cloud.analitico.ai;

        ssl_certificate           /root/certs/analitico.ai.crt;
        ssl_certificate_key       /root/certs/analitico.ai.key;

        location / {
                proxy_pass    http://k8prometheusNodes;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;
                proxy_set_header Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
            }
}


# ssl for .analitico.ai, still missing proxy_pass ssl
server {
        listen 443 ssl;
        server_name .analitico.ai analitico.ai;

        ssl_certificate           /root/certs/analitico.ai.crt;
        ssl_certificate_key       /root/certs/analitico.ai.key;

        location / {
                proxy_pass    http://k8nodes;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;
		# map to hostname of website service to be recognized by knative
                proxy_set_header Host website.cloud.analitico.ai;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
		proxy_redirect off;    
	}
}


# ssl for *.cloud.analitico.ai, still missing proxy_pass ssl
server {
        listen 443 ssl;
        server_name *.cloud.analitico.ai cloud.analitico.ai;

        ssl_certificate           /root/certs/analitico.ai.crt;
        ssl_certificate_key       /root/certs/analitico.ai.key;

        location / {
                proxy_pass    http://k8nodes;
                proxy_http_version 1.1;
                proxy_connect_timeout 1s;   
                proxy_set_header Host $host;
                proxy_next_upstream error timeout  invalid_header http_500  http_502 http_503 http_504;
            }
}


